<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Fabrique du texte</title>
</head>
<body>
  <div class="main">
    <div class="title_zone">
        <h1>Fabrique de texte ServicesPublics+</h1>
    </div>

    <article>
        <div class="submission_text">
            <h2>Éléments du texte à générer</h2>
            <form action="/api/fabrique" method="post">
              <div>
                <label for="user_text">La question posée par un citoyen français</label>
                <textarea type="text" id="user_text" name="user_text" value="" rows="5" required>{{ user_text|safe }}</textarea>
                <label for="institution">L'institution concernée</label>
                <input type="text" id="institution" name="institution" value="{{ institution|safe }}">
                <label for="context">De courts éléments de réponses</label>
                <textarea type="text" id="context" name="context" value="" rows="3">{{ context|safe }}</textarea>
                <label for="links">Un ou plusieurs liens (séparés par des virgules)</label>
                <textarea type="text" id="links" name="links" value="" rows="3">{{ links|safe }}</textarea>
                <label for="temperature">Degré d'originalité de la génération de texte (entre 0 et 1)</label>
                <input type="text" value="{{ temperature|safe }}" id="temperature" name="temperature" style="width:40px;">
              </div>
              <button class="generator" type="submit">Générer une réponse</button>
            </form>
        </div>

        <div class="result_text">
          <h2>
            Réponse
            <button id="stop" class="stop_generator" style="display: none;"><div id="loader" class="loader is-small" style="margin-right: 10px;"></div>Stop generation</button>
          </h2>

          {% if is_streaming %}
            <div id="result" class="result" style="white-space: pre-wrap;">
            </div>

            <script>
              var stream_chat = new EventSource("/api/fabrique_stream");
              var target_output = document.getElementById("result");
              var $loader = document.getElementById("stop");

              $loader.style.display = 'inline-block';

              stream_chat.onmessage = function (e) {
                text = JSON.parse(e.data);
                if (text == "[DONE]") {
                    stream_chat.close();
                    $loader.style.display = 'none';
                } else {
                  target_output.innerHTML += text;
                }
              };

              function stopGeneration() {
                  stream_chat.close();
                  $loader.style.display = 'none';

                  fetch('/api/fabrique_stop')
                    .then(response => {})
                    .catch(error => console.error('Error:', error));
              }

              // Attach the function event to the button
              $loader.addEventListener('click', stopGeneration);

            </script>
          {% endif %}

        </div>
    </article>
  </div>
</body>
</html>
